<!-- CLINICAL DOSSIER MODULAR LAYOUT - UNIFIED CARD -->
<article class="clinical-dossier-container modal-root">

    <!-- GLOBAL HEADER (Full Width) -->
    <header class="clinical-header">
        <div>
            <h2 class="clinical-title mb-0">{{ client ? client.name : 'Cargando...' }}</h2>
            <span class="text-muted small">Expediente #{{ client ? client.id : '---' }}</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="badge badge-soft px-3 py-1 mr-3">ACTIVO</span>
            <button mat-icon-button (click)="close()" class="text-gray-400 hover:text-dark">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </header>

    <!-- CONTENT BODY (Split Columns) -->
    <div class="clinical-body">

        <!-- LEFT COLUMN (Data & Observations) -->
        <div class="dossier-left-col">
            <div class="d-flex flex-column h-100" *ngIf="client">

                <!-- 1. PROFILE PHOTO & STATS SECTION (STRICT GRID) -->
                <div class="dossier-stats-grid">

                    <!-- COLUMN 1: Photo & Button -->
                    <div class="d-flex flex-column align-items-center">
                        <figure class="clinical-photo-frame m-0"
                            style="width: 100px; height: 100px; border-width: 3px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <img *ngIf="client.profilePicture" [src]="client.profilePicture"
                                class="w-100 h-100 fit-cover">
                            <mat-icon *ngIf="!client.profilePicture" style="font-size: 48px; width: 48px; height: 48px;"
                                class="text-gray-400">person</mat-icon>

                            <!-- Camera Overlay (Visible only in Edit Mode) -->
                            <div *ngIf="isEditing" class="photo-edit-overlay">
                                <mat-icon>photo_camera</mat-icon>
                            </div>
                        </figure>
                    </div>

                    <!-- COLUMN 2: Stat Card 1 (Citas) -->
                    <div class="dossier-stat-card">
                        <div class="stat-header">
                            <mat-icon class="stat-icon" style="color: #4f46e5;">event_note</mat-icon>
                            <span class="stat-label">Citas</span>
                        </div>
                        <strong class="stat-value large">{{ stats?.totalAppointments || 0 }}</strong>
                    </div>

                    <!-- COLUMN 3: Stat Card 2 (Última) -->
                    <div class="dossier-stat-card">
                        <div class="stat-header">
                            <mat-icon class="stat-icon" style="color: #10b981;">history</mat-icon>
                            <span class="stat-label">Última</span>
                        </div>
                        <strong class="stat-value medium">
                            {{ stats?.lastAppointment ? (stats.lastAppointment | date:'d MMM') : '--' }}
                        </strong>
                    </div>

                    <!-- COLUMN 4: Stat Card 3 (Favorito) -->
                    <div class="dossier-stat-card">
                        <div class="stat-header">
                            <mat-icon class="stat-icon" style="color: #f59e0b;">star</mat-icon>
                            <span class="stat-label">Favorito</span>
                        </div>
                        <strong class="stat-value small" [matTooltip]="stats?.preferredBarber">
                            {{ stats?.preferredBarber || '--' }}
                        </strong>
                    </div>
                </div>

                <!-- 2. DATA GRID (Side-by-Side) -->
                <div class="clinical-info-grid">
                    <!-- Right: Personal Data -->
                    <section class="clinical-section-card h-100">
                        <header class="clinical-card-title mb-3">
                            <mat-icon>face</mat-icon> Datos Personales
                        </header>
                        <div class="clinical-field-group mb-2">
                            <label class="clinical-label">Edad</label>
                            <input type="number" class="clinical-input-box" [(ngModel)]="client.age"
                                [readonly]="!isEditing">
                        </div>
                        <div class="clinical-field-group">
                            <label class="clinical-label">Género</label>
                            <select class="clinical-input-box" [(ngModel)]="client.gender" [disabled]="!isEditing">
                                <option value="Male">Masculino</option>
                                <option value="Female">Femenino</option>
                                <option value="Other">Otro</option>
                            </select>
                        </div>
                    </section>

                    <!-- Left: Contact Digital -->
                    <section class="clinical-section-card h-100">
                        <header class="clinical-card-title mb-3">
                            <mat-icon>contact_phone</mat-icon> Contacto Digital
                        </header>
                        <div class="clinical-field-group mb-2">
                            <label class="clinical-label">Email</label>
                            <input type="email" class="clinical-input-box" [(ngModel)]="client.email"
                                [readonly]="!isEditing">
                        </div>
                        <div class="clinical-field-group">
                            <label class="clinical-label">Teléfono</label>
                            <input type="tel" class="clinical-input-box" [(ngModel)]="client.phone"
                                [readonly]="!isEditing">
                        </div>
                    </section>
                </div>

                <!-- 3. OBSERVATIONS (Full Width Bottom) -->
                <div class="d-flex flex-column flex-grow-1" style="min-height: 200px;">
                    <section class="clinical-section-card h-100 flex-grow-1 d-flex flex-column">
                        <header class="clinical-card-title mb-2">
                            <mat-icon>notes</mat-icon> Observaciones
                        </header>
                        <textarea class="clinical-input-box border-0 bg-transparent p-2 flex-grow-1"
                            style="resize: none;" placeholder="Escriba notas relevantes sobre el cliente..."
                            [(ngModel)]="client.observations" [readonly]="!isEditing"></textarea>
                    </section>

                    <!-- Actions Bar -->
                    <div class="mt-3 d-flex justify-content-end">
                        <button *ngIf="!isEditing" class="btn-clinical-outline" (click)="toggleEdit()">Editar
                            Expediente</button>
                        <button *ngIf="isEditing" class="btn-clinical-primary ml-2" (click)="saveProfile()">Guardar
                            Cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR (History) -->
        <aside class="dossier-right-col dark-theme">
            <!-- Timeline Header -->
            <div class="p-3 border-bottom border-dark-subtle">
                <h5 class="clinical-title text-light mb-0" style="font-size: 1rem;">Historial de Citas</h5>
            </div>

            <!-- Timeline Container -->
            <div class="history-scroll-container position-relative p-3">
                <div class="timeline-dark" *ngIf="history && history.length > 0">
                    <div class="timeline-item" *ngFor="let apt of history" (click)="selectAppointment(apt)">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <div class="appointment-header">
                                <span class="date-text">{{ apt.startTime | date:'mediumDate' }}</span>
                                <span class="status-badge-small" [ngClass]="apt.status.toLowerCase()">{{ apt.status
                                    }}</span>
                            </div>

                            <div class="appointment-body">
                                <div class="service-info">
                                    <h4 class="service-name">{{ apt.appointmentType?.name || 'Servicio General' }}</h4>
                                    <div class="time-info">
                                        <mat-icon>schedule</mat-icon>
                                        {{ apt.startTime | date:'shortTime' }}
                                    </div>
                                </div>
                                <div class="barber-info" *ngIf="apt.barber">
                                    <div class="barber-avatar-small"
                                        [style.background-color]="apt.barber.color || '#666'">
                                        {{ apt.barber.name.charAt(0) }}
                                    </div>
                                    <span class="barber-name-small">{{ apt.barber.name }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div *ngIf="!history || history.length === 0" class="empty-state-dark">
                    <p>Sin historial disponible.</p>
                </div>
            </div>
        </aside>

    </div>
</article>

<!-- Appointment Detail Overlay (Inside Modal) -->
<div class="detail-overlay" *ngIf="selectedAppointment" (click)="clearSelection()"
    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 50; display: flex; align-items: center; justify-content: center;">

    <div class="modal-card-lux compact animate-slide-up" (click)="$event.stopPropagation()">
        <button class="close-btn-sexy" (click)="clearSelection()">
            <mat-icon>close</mat-icon>
        </button>

        <div class="text-center mb-4">
            <div class="text-uppercase text-gray small tracking-wider mb-2">Detalle de Cita #{{ selectedAppointment.id
                }}</div>
            <h2 class="text-white mb-0">{{ selectedAppointment.startTime | date:'mediumDate' }}</h2>
            <div class="text-accent h4">{{ selectedAppointment.startTime | date:'shortTime' }}</div>
        </div>

        <div class="info-grid p-3 card-glass mb-4">
            <div class="row mb-3">
                <div class="col-6">
                    <label class="text-gray small d-block mb-1">Estado</label>
                    <span class="font-weight-bold text-white">{{ selectedAppointment.status }}</span>
                </div>
                <div class="col-6">
                    <label class="text-gray small d-block mb-1">Servicio</label>
                    <span class="font-weight-bold text-white">{{ selectedAppointment.appointmentType?.name || 'Standard'
                        }}</span>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <label class="text-gray small d-block mb-1">Barbero</label>
                    <div class="d-flex align-items-center">
                        <div class="color-dot" [style.background]="selectedAppointment.barber?.color"></div>
                        <span class="text-white">{{ selectedAppointment.barber?.name }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="notes-section" *ngIf="selectedAppointment.notes">
            <label class="text-gray small d-block mb-2">Notas</label>
            <div class="p-3 bg-dark rounded border border-secondary text-light font-monospace small">
                {{ selectedAppointment.notes }}
            </div>
        </div>
    </div>
</div>